{% load custom_filters %}

<br><hr><br>

<div class="row">
    <div class="col-12 table-responsive">
        <table id="quiz-results-table" class="table table-striped text-center align-middle">
            <thead class="bg-p-grey text-t-grey align-middle">
                <tr>
                    <!-- superusers can view the username, quiz-type, and total duration -->
                    {% if user.is_superuser %}
                        <th scope="col">User</th>
                        <th scope="col">Type</th>
                        <th scope="col">Duration<br><small>(h:m:s)</small></th>
                    {% endif %}
                    <th scope="col">Date<br><small>Time</small></th>
                    <th scope="col">Correct<br>Answers</th>
                    <th scope="col">Accuracy</th>
                    <th scope="col"></th>
                </tr>
            </thead>
            <tbody>
                {% for result in results %}
                    <tr class="result-row">
                        <!-- superusers can view the username, quiz-type, and total duration -->
                        {% if user.is_superuser %}
                            <td>{{ result.quiz.user.profile.display_name }}</td>
                            <td>{{ result.quiz.quiz }}</td>
                            <td>{{ result.duration }}</td>
                        {% endif %}
                        <td>
                            <!-- quiz date taken -->
                            {{ result.quiz.taken|date:"d M Y"|upper }}<br>
                            <small class="text-muted">{{ result.quiz.taken|date:"H:i A" }}</small>
                        </td>
                        <td>
                            <!-- quiz results for current mentors only -->
                            {% if result.quiz.quiz|safe == "is_mentor" %}
                                {{ result.correct }}<br>
                                <small class="text-muted">out of {{ result.questions }}</small>
                            {% else %}
                                <small class="text-muted">N/A</small>
                            {% endif %}
                        </td>
                        <td>
                            <!-- percentage of questions correct for current mentors only -->
                            {% if result.quiz.quiz|safe == "is_mentor" %}
                                <span class="fw-bold {% if result.percentage >= 90 %}text-success{% elif result.percentage >= 80 %}text-primary{% elif result.percentage >= 70 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ result.percentage }}%<br>
                                </span>
                                <small class="text-muted">
                                    {% if result.percentage >= 90 %} distinction
                                    {% elif result.percentage >= 80 %} merit
                                    {% elif result.percentage >= 70 %} pass
                                    {% else %} fail
                                    {% endif %}
                                </small>
                            {% else %}
                                <small class="text-muted">N/A</small>
                            {% endif %}
                        </td>
                        <td>
                            <!-- opens modal for individual quiz results -->
                            <button type="button" class="btn btn-ci" data-bs-toggle="modal" data-bs-target="#modal-results-{{ forloop.counter }}">
                                Results
                            </button>
                        </td>
                    </tr>
                    <!-- results modals (must be inside of forloop) -->
                    {% include "accounts/partials/results_modal.html" %}
                {% empty %}
                    <!-- only display if no quiz results are found -->
                    <tr>
                        <td colspan="7"><h3>No matching records found</h3></td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    // convert question durations from seconds into hh:mm:ss
    let timePills = document.querySelectorAll(".time-convert");
    timePills.forEach(pill => {
        pill.innerText = new Date(pill.innerText * 1000).toISOString().substr(11, 8);
    });

    // fixes Issue #8 (https://github.com/TravelTimN/ci-mentor-quiz/issues/8)
    let userAnswers = document.querySelectorAll(".user-answer");
    userAnswers.forEach(answer => {
        // // slice the start and end to remove the list declarations
        // answer.innerText = answer.innerText.trim();
        // if (answer.innerText.slice(0,2) == `["` || answer.innerText.slice(0,2) == `['`) {
        //     answer.innerText = answer.innerText.slice(2);
        // }
        // if (answer.innerText.slice(-2) == `']` || answer.innerText.slice(-2) == `"]`) {
        //     answer.innerText = answer.innerText.slice(0,-2);
        // }
        // // remove extra quotes from list declaration
        // if (answer.innerText.includes(`", "`) || answer.innerText.includes(`', '`)) {
        //     answer.innerText = answer.innerText.replace(`", "`, ", ").replace(`', '`, ", ");
        // }
        // use RegEx to replace \r and \n with a line break
        answer.innerHTML = answer.innerHTML.replace(/\\r\\n/g, "<br>");
    });
</script>
