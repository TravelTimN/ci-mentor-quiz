{% load custom_filters %}

<br><hr><br>

<div class="row">
    <div class="col-12 table-responsive">
        <table id="quiz-results-table" class="table table-striped text-center align-middle">
            <thead class="bg-p-grey text-t-grey align-middle">
                <tr>
                    {% if user.is_superuser %}
                        <th scope="col">User</th>
                        <th scope="col">Type</th>
                        <th scope="col">Duration<br><small>(h:m:s)</small></th>
                    {% endif %}
                    <th scope="col">Date<br><small>Time</small></th>
                    <th scope="col">Correct<br>Answers</th>
                    <th scope="col">Accuracy</th>
                    <th scope="col"></th>
                </tr>
            </thead>
            <tbody>
                {% for result in results %}
                <tr class="result-row">
                    {% if user.is_superuser %}
                        <td>{{ result.quiz.user }}</td>
                        <td>{{ result.quiz }}</td>
                        <td>{{ result.duration }}</td>
                    {% endif %}
                    <td>
                        {{ result.quiz.taken|date:"d M Y"|upper }}<br>
                        <small class="text-muted">{{ result.quiz.taken|date:"H:i A" }}</small>
                    </td>
                    <td>
                        {{ result.correct }}<br>
                        <small class="text-muted">out of {{ result.questions }}</small>
                    </td>
                    <td>
                        <span class="fw-bold {% if result.percentage >= 90 %}text-success{% elif result.percentage >= 80 %}text-primary{% elif result.percentage >= 70 %}text-warning{% else %}text-danger{% endif %}">
                            {{ result.percentage }}%<br>
                        </span>
                        <small class="text-muted">
                            {% if result.percentage >= 90 %}
                                distinction
                            {% elif result.percentage >= 80 %}
                                merit
                            {% elif result.percentage >= 70 %}
                                pass
                            {% else %}
                                fail
                            {% endif %}
                        </small>
                    </td>
                    <td>
                        <button type="button" class="btn btn-ci" data-bs-toggle="modal" data-bs-target="#modal-results-{{ forloop.counter }}">
                            Results
                        </button>
                    </td>
                </tr>
                <!-- results modals (must be inside of forloop) -->
                <aside class="modal fade" id="modal-results-{{ forloop.counter }}" tabindex="-1" aria-labelledby="modal-results-label-{{ forloop.counter }}" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="modal-results-label-{{ forloop.counter }}">
                                    {{ result.quiz.user }} |
                                    <small class="text-muted">
                                        {{ result.quiz.taken|date:"dMY"|upper }}
                                        {% if result.percentage >= 90 %}
                                            <span class="text-success">(distinction)</span>
                                        {% elif result.percentage >= 80 %}
                                            <span class="text-primary">(merit)</span>
                                        {% elif result.percentage >= 70 %}
                                            <span class="text-warning">(pass)</span>
                                        {% else %}
                                            <span class="text-danger">(fail)</span>
                                        {% endif %}
                                    </small>
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <!-- start collapsible body content -->
                                {% for answer in result.answers %}
                                    <!-- TODO: convert this to a table perhaps? -->
                                    <div class="list-group">
                                        <div class="list-group-item list-group-item-{% if answer.is_correct %}success{% else %}danger{% endif %}">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1 pr-3">Q: {{ answer.question }}</h6>
                                                <small class="text-muted">{{ answer.question.subject }}</small>
                                            </div>
                                            <!-- custom django templatetag: |replace"foo|bar" -->
                                            <p class="mb-1">User Answer:<br>
                                                <!-- TODO: fix \r and \n to actually display a proper linebreak -->
                                                {{ answer.user_answer|safe|linebreaksbr|replace:"['|"|replace:"']|"|replace:"', '|, " }}
                                                <!-- {{ answer.user_answer|safe|linebreaksbr|cut:"['"|cut:"']" }} -->
                                            </p>
                                            {% if user.is_superuser %}
                                                <small class="text-muted">Time Taken: {{ answer.time_taken }} second{{ answer.time_taken|pluralize }} / </small>
                                            {% endif %}
                                            <small class="text-muted">Result: {% if answer.is_correct == True %}Correct{% else %}Incorrect{% endif %}</small>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </aside>
                {% empty %}
                <!-- only display if no quiz results are found -->
                <tr>
                    <td colspan="7"><h3>No matching records found</h3></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
